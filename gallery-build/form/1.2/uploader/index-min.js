/**
 * @fileoverview 文件上传验证
 * @author: 剑平（明河）<minghe36@126.com>
 **/KISSY.add("gallery/form/1.2/uploader/auth/base",function(a,b,c){function h(b,c){var d=this;c=a.merge({uploader:b},c),h.superclass.constructor.call(d,c),d._init()}var d="",e=b.all,f=f||a,g="[uploader-auth]:";return a.mix(h,{event:{ERROR:"error"}}),a.extend(h,c,{_init:function(){var a=this,b=a.get("uploader"),c=b.get("queue");if(b==d)return f.log(g+"uploader\u4e0d\u53ef\u4ee5\u4e3a\u7a7a\uff01"),!1;a._setSwfButtonExt(),c.on("add",function(b){var c=b.file;a.testAllowExt(c),a.testMaxSize(c),a.testRepeat(c)}),c.on("remove",function(b){var c=b.file,d=c.status;d=="success"&&a.testMax()}),c.on("statusChange",function(b){var c=b.status;c=="success"&&a.testMax()}),b.on("error",function(a){b.set("isAllowUpload",!0)})},testAll:function(){var a=this;return a.testRequire()&&a.testMax()},getRule:function(a){var b=this,c=b.get("rules");return c[a]},isUploaderType:function(a){var b=this,c=b.get("uploader"),d=c.get("type");return a==d},testRequire:function(){var b=this,c=b.get("uploader"),d=c.get("urlsInput"),e=d.get("urls"),f=b.getRule("require"),h=f?f[0]:!1,i=e.length>0;return h?(i||(a.log(g+f[1]),b._fireUploaderError("require",f)),i):!0},testAllowExt:function(b){function j(b){var c=!1,d;return a.each(f,function(a){d=new RegExp("^.+."+a+"$");if(d.test(b))return c=!0}),c}function k(a){var b=a.split(".");return b[b.length-1]}if(!a.isObject(b))return!1;var c=this,d=b.name,e=c.getRule("allowExts"),f=[],g,h,i;return a.isArray(e)?(f=c._getExts(e[0].ext),i=j(d),i||(g=k(d),h=a.substitute(e[1],{ext:g}),c._fireUploaderError("allowExts",[e[0],h],b)),i):!1},testMax:function(){var b=this,c=b.get("uploader"),d=c.get("queue"),e=d.getFiles("success"),f=e.length,g=b.getRule("max"),h;if(g){var i=c.get("button"),j=f<g[0];return j?(i.set("disabled",!1),c.set("isAllowUpload",!0)):(c.set("disabled",!0),c.set("isAllowUpload",!1),h=a.substitute(g[1],{max:g[0]}),b._fireUploaderError("max",[g[0],h])),j}},testMaxSize:function(b){var c=this,d=b.size,e=c.getRule("maxSize");if(e){var f=Number(e[0])*1e3,g=d<=f,h;return g||(h=a.substitute(e[1],{maxSize:a.convertByteSize(f),size:b.textSize}),c._fireUploaderError("maxSize",[e[0],h],b)),g}},testRepeat:function(b){if(!a.isObject(b))return!1;var c=this,d=b.name,e=c.getRule("allowRepeat");if(e){var f=e[0],g=c.get("uploader"),h=g.get("queue"),i=h.getFiles("success"),j=!1;return f?!1:(a.each(i,function(a){if(a.name==d)return c._fireUploaderError("allowRepeat",e,b),j=!0}),j)}},_setSwfButtonExt:function(){var b=this,c=b.get("uploader"),d=b.getRule("allowExts"),e=c.get("button"),f=b.isUploaderType("flash");return!f||!a.isArray(d)?!1:(e.set("fileFilters",d[0]),b)},_getExts:function(b){if(!a.isString(b))return!1;var c=b.split(";"),d=[],e=/^\*\./;return a.each(c,function(a){a=a.replace(e,""),d.push(a.toUpperCase())}),a.each(d,function(a){c.push(a)}),c},_fireUploaderError:function(b,c,d){var e=this,f=e.get("uploader"),g=f.get("queue"),i={status:-1,rule:b},j=-1;d&&(a.mix(i,{file:d}),j=g.getFileIndex(i.file.id)),c&&a.mix(i,{msg:c[1],value:c[0]}),g.fileStatus(j,"error",i),e.fire(h.event.ERROR,i),f.fire("error",i)}},{ATTRS:{uploader:{value:d},rules:{value:{allowExts:[{desc:"JPG,JPEG,PNG,GIF,BMP",ext:"*.jpg;*.jpeg;*.png;*.gif;*.bmp"},"\u4e0d\u652f\u6301{ext}\u683c\u5f0f\u7684\u6587\u4ef6\u4e0a\u4f20\uff01"],require:[!1,"\u5fc5\u987b\u81f3\u5c11\u4e0a\u4f20\u4e00\u4e2a\u6587\u4ef6\uff01"],max:[3,"\u6bcf\u6b21\u6700\u591a\u4e0a\u4f20{max}\u4e2a\u6587\u4ef6\uff01"],maxSize:[1e3,"\u6587\u4ef6\u5927\u5c0f\u4e3a{size}\uff0c\u6587\u4ef6\u592a\u5927\uff01"],allowRepeat:[!1,"\u8be5\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\uff01"]}}}}),h},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/base",function(a,b,c,d,e,f,g,h,i,j){function n(a){var b=this;n.superclass.constructor.call(b,a)}var k="",l=c.all,m="[uploader]:";return a.mix(n,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{RENDER:"render",SELECT:"select",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"}}),a.extend(n,b,{render:function(){var b=this,c=b.get("serverConfig"),d=b.get("type"),e=b.getUploadType(d),f,g=e.event,h;return e?(h=b._renderButton(),b.set("urlsInput",b._renderUrlsInput()),b._renderQueue(),b.get("type")==n.type.FLASH&&a.mix(c,{swfUploader:h.get("swfUploader")}),f=new e(c),f.on(g.SUCCESS,b._uploadCompleteHanlder,b),g.PROGRESS&&f.on(g.PROGRESS,b._uploadProgressHandler,b),f.on(g.STOP,b._uploadStopHanlder,b),b.set("uploadType",f),b.fire(n.event.RENDER),b):!1},upload:function(b){if(!a.isNumber(b))return!1;var c=this,d=c.get("uploadType"),e=c.get("type"),f=c.get("queue"),g=f.get("files")[b],h;if(!a.isPlainObject(g))return a.log(m+"\u961f\u5217\u4e2d\u4e0d\u5b58\u5728id\u4e3a"+b+"\u7684\u6587\u4ef6"),!1;if(c.get("curUploadIndex")!=k)return alert("\u7b2c"+c.get("curUploadIndex")+"\u6587\u4ef6\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u4e0a\u4f20\u5b8c\u540e\u518d\u64cd\u4f5c\uff01"),!1;h=g.input.id||g.input,e=="ajax"&&(h=g.data);if(g.status==="error")return!1;c.fire(n.event.START,{index:b,file:g});if(!c.get("isAllowUpload"))return!1;c.set("curUploadIndex",b),f.fileStatus(b,n.status.START),d.upload(h)},cancel:function(b){var c=this,d=c.get("uploadType"),e=c.get("queue"),f=n.status,g=e.fileStatus(b);return a.isNumber(b)&&g!=f.SUCCESS?(d.stop(),e.fileStatus(b,f.CANCEL)):(d.stop(),c._continueUpload()),c},stop:function(){var a=this;return a.set("uploadFilesStatus",k),a.cancel(),a},uploadFiles:function(b){var c=this;return a.isString(b)||(b=n.status.WAITING),c.set("uploadFilesStatus",b),c._uploaderStatusFile(b),c},_uploaderStatusFile:function(a){var b=this,c=b.get("queue"),d=c.getIndexs(a);return d.length?(b.upload(d[0]),b):(b.set("uploadFilesStatus",k),b.fire(n.event.UPLOAD_FILES),!1)},isSupportAjax:function(){var a=!1;try{FormData&&(a=!0)}catch(b){a=!1}return a},isSupportFlash:function(){var b=a.UA.fpv();return a.isArray(b)&&b.length>0},getUploadType:function(b){var c=this,d=n.type,e;return b==d.AUTO&&(b=[d.AJAX,d.FLASH,d.IFRAME]),a.isArray(b)&&b.length>0?a.each(b,function(a){e=c._getType(a);if(e)return!1}):e=c._getType(b),e},_getType:function(b){var c=this,d=n.type,h,i=c.isSupportAjax(),j=c.isSupportFlash();switch(b){case d.IFRAME:h=e;break;case d.AJAX:h=i&&f||!1;break;case d.FLASH:h=j&&g||!1;break;default:return a.log(m+"type\u53c2\u6570\u4e0d\u5408\u6cd5"),!1}return h&&a.log(m+"\u4f7f\u7528"+b+"\u4e0a\u4f20\u65b9\u5f0f"),c.set("type",b),h},_renderButton:function(){var b=this,c,d,e=b.get("type"),f=b.get("target"),g=b.get("multiple"),j=b.get("disabled"),k=b.get("name"),l={name:k,multiple:g,disabled:j};return e==n.type.FLASH?(d=i,a.mix(l,{size:b.get("swfSize")})):d=h,c=new d(f,l),c.on("change",b._select,b),c.render(),b.set("button",c),c},_renderQueue:function(){var b=this,c=new j,d=b.get("urlsInput");return a.isObject(c)?(c.set("uploader",b),c.on("remove",function(a){a.file.sUrl&&d&&d.remove(a.file.sUrl)}),b.set("queue",c),c):(a.log(m+"queue\u53c2\u6570\u4e0d\u5408\u6cd5"),!1)},_select:function(b){var c=this,d=c.get("autoUpload"),e=c.get("queue"),f=c.get("curUploadIndex"),g=b.files;a.each(g,function(a){a.size||(a.size=0),a.name||(a.name=a.fileName||k),a.input=b.input||a}),g=c._processExceedMultiple(g),c.fire(n.event.SELECT,{files:g});if(!c.get("isAllowUpload"))return!1;e.add(g,function(){f==k&&d&&c.uploadFiles()})},_processExceedMultiple:function(b){var c=this,d=c.get("multipleLen");return d<0||!a.isArray(b)||!b.length?b:a.filter(b,function(a,b){return b<d})},_renderUrlsInput:function(){var a=this,b=a.get("button"),c=b.get("target"),e=a.get("urlsInputName"),f=new d(c,{name:e});return f.render(),f},_uploadCompleteHanlder:function(b){var c=this,d=b.result,e,f=n.event,g=c.get("queue"),h=c.get("curUploadIndex");if(!a.isObject(d))return!1;g.updateFile(h,{result:d}),e=Number(d.status);if(e===1)g.fileStatus(h,n.status.SUCCESS),c._success(d.data),c.fire(f.SUCCESS,{index:h,file:g.getFile(h),result:d});else{var i=d.msg||d.message||k;g.fileStatus(h,n.status.ERROR,{msg:i,result:d}),c.fire(f.ERROR,{status:e,result:d,index:h,file:g.getFile(h)})}c.set("curUploadIndex",k),c.fire(f.COMPLETE,{index:h,file:g.getFile(h),result:d}),c._continueUpload()},_uploadStopHanlder:function(){var a=this,b=a.get("queue"),c=a.get("curUploadIndex");b.fileStatus(c,n.status.CANCEL),a.set("curUploadIndex",k),a.fire(n.event.CANCEL,{index:c})},_continueUpload:function(){var a=this,b=a.get("uploadFilesStatus");b!=k&&a._uploaderStatusFile(b)},_uploadProgressHandler:function(b){var c=this,d=c.get("queue"),e=c.get("curUploadIndex"),f=d.getFile(e);a.mix(b,{file:f}),d.fileStatus(e,n.status.PROGRESS,b),c.fire(n.event.PROGRESS,b)},_success:function(b){if(!a.isObject(b))return!1;var c=this,d=b.url,e=c.get("urlsInput"),f=c.get("curUploadIndex"),g=c.get("queue");if(!a.isString(d)||!a.isObject(e))return!1;g.updateFile(f,{sUrl:d}),e.add(d)},restore:function(b){var c=this,d=c.get("queue"),e=c.get("urlsInput");b||(b=c._getRestoreData());if(!b.length)return!1;a.each(b,function(a){!a.sUrl&&a.result&&(a.sUrl=a.result.data.url);var b=d.add(a),c=b.id,f=d.getFileIndex(c);e.add(a.sUrl),d.fileStatus(f,"success",{index:f,id:c,file:b})})},_getRestoreData:function(){var b=this,c=b.get("restoreHook"),d=l(c);return d.length?a.JSON.parse(a.trim(d.html())):[]}},{ATTRS:{button:{value:{}},queue:{value:{}},type:{value:n.type.AUTO},multiple:{value:!0,setter:function(b){var c=this,d=c.get("button");return!a.isEmptyObject(d)&&a.isBoolean(b)&&d.set("multiple",b),b}},multipleLen:{value:-1},disabled:{value:!1,setter:function(b){var c=this,d=c.get("button");return!a.isEmptyObject(d)&&a.isBoolean(b)&&d.set("disabled",b),b}},serverConfig:{value:{action:k,data:{},dataType:"json"}},data:{value:{},getter:function(){var a=this,b=a.get("uploadType"),c=a.get("serverConfig").data||{};return b&&(c=b.get("data")),c},setter:function(b){if(a.isObject(b)){var c=this,d=c.get("uploadType");d&&(d.set("data",b),c.set("serverConfig",a.mix(c.get("serverConfig"),{data:b})))}return b}},isAllowUpload:{value:!0},autoUpload:{value:!0},urlsInputName:{value:k},curUploadIndex:{value:k},uploadType:{value:{}},urlsInput:{value:k},uploadFilesStatus:{value:k},restoreHook:{value:k},swfSize:{value:{}}}}),a.convertByteSize=function(a){var b=-1;do a/=1024,b++;while(a>99);return Math.max(a,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]},n},{requires:["base","node","./urlsInput","./type/iframe","./type/ajax","./type/flash","./button/base","./button/swfButton","./queue"]}),KISSY.add("gallery/form/1.2/uploader/button/base",function(a,b,c){function g(b,c){var d=this;c=a.merge({target:f(b)},c),g.superclass.constructor.call(d,c)}var d="",e="[Uploader-Button] ",f=b.all;return a.mix(g,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(a){return a.replace(/.*(\/|\\)/,"")}}),a.extend(g,c,{render:function(){var b=this,c=b.get("target"),d=b.fire(g.event.beforeRender);return d===!1?(a.log(e+"button render was prevented."),!1):c==null?(a.log(e+"Cannot find target!"),!1):(b._createInput(),b.fire(g.event.afterRender),b)},show:function(){var a=this,b=a.get("target");return b.show(),a.fire(g.event.afterShow),g},hide:function(){var a=this,b=a.get("target");return b.hide(),a.fire(g.event.afterHide),g},reset:function(){var a=this,b=a.get("inputContainer");return f(b).remove(),a.set("inputContainer",d),a.set("fileInput",d),a._createInput(),a},_createInput:function(){var b=this,c=b.get("target"),d=b.get("name"),g=b.get("tpl"),h,i,j;return!a.isString(d)||!a.isString(g)?(a.log(e+"No name or tpl specified."),!1):(h=a.substitute(g,{name:d}),i=f(h),f(i).appendTo(c),j=f(i).children("input"),a.UA.ie==6&&j.css("fontSize","400px"),f(j).on("change",b._changeHandler,b),b.set("fileInput",j),b.set("inputContainer",i),b._setDisabled(b.get("disabled")),b._setMultiple(b.get("multiple")),i)},_changeHandler:function(b){var c=this,h=c.get("fileInput"),i=f(h).val(),j=b.target.files,k=[];if(i==d)return a.log(e+"No file selected."),!1;j?a.each(j,function(b){a.isObject(b)&&k.push({name:b.name,type:b.type,size:b.size,data:b})}):k.push({name:g.getFileName(i)}),c.fire(g.event.CHANGE,{files:k,input:h.getDOMNode()}),c.reset()},_setDisabled:function(b){var c=this,d=c.get("cls"),e=d.disabled,g=c.get("target"),h=c.get("fileInput");return!g.length||!a.isBoolean(b)?!1:(b?(g.addClass(e),f(h).hide()):(g.removeClass(e),f(h).show()),b)},_setMultiple:function(a){var b=this,c=b.get("fileInput");return c.length?(a&&c.attr("multiple","multiple")||c.removeAttr("multiple"),a):!1}},{ATTRS:{target:{value:null},fileInput:{value:d},inputContainer:{value:d},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(a){return this.get("fileInput")&&f(this.get("fileInput")).attr("name",a),a}},disabled:{value:!1,setter:function(a){return this._setDisabled(a),a}},multiple:{value:!0,setter:function(a){return this._setMultiple(a),a}},cls:{value:{disabled:"uploader-button-disabled"}}}}),g},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/button/swfButton",function(a,b,c,d){function h(b,c){var d=this;c=a.merge({target:f(b)},c),h.superclass.constructor.call(d,c)}var e="",f=b.all,g="swf-uploader-wrapper-";return a.mix(h,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}}),a.extend(h,c,{render:function(){var a=this,b=a.get("target"),c,d=a.get("multiple"),e=a.get("fileFilters");b.css("position","relative"),a.set("swfWrapper",a._createSwfWrapper()),a._setFlashSizeConfig(),c=a._initSwfUploader(),c.on("contentReady",function(b){c.browse(d,e),a._bindBtnEvent(),c.on("fileSelect",a._changeHandler,a),a._setDisabled(a.get("disabled")),a.fire(h.event.RENDER)},a)},_createSwfWrapper:function(){var b=this,c=b.get("target"),d=b.get("tpl"),h=b.get("swfWrapperId")!=e&&b.get("swfWrapperId")||g+a.guid(),i=a.substitute(d,{id:h});return b.set("swfWrapperId",h),f(i).appendTo(c)},_initSwfUploader:function(){var b=this,c=b.get("flash"),e=b.get("swfWrapperId"),f;a.mix(c,{id:"swfUploader"+a.guid()});try{f=new d(e,c),b.set("swfUploader",f)}catch(g){}return f},_bindBtnEvent:function(){var b=this,c=h.event,d=b.get("swfUploader");return d?(a.each(c,function(a){d.on(a,function(c){b.fire(a)},b)}),b):!1},_setFlashSizeConfig:function(){var b=this,c=b.get("flash"),d=b.get("target"),e=b.get("size");a.isEmptyObject(e)?a.mix(c.attrs,{width:d.innerWidth(),height:d.innerHeight()}):a.mix(c.attrs,e),b.set("flash",c)},_changeHandler:function(a){var b=this,c=a.fileList;b.fire(h.event.CHANGE,{files:c})},_setDisabled:function(b){var c=this,d=c.get("swfUploader"),e=c.get("cls"),f=e.disabled,g=c.get("target"),h=c.get("swfWrapper");return!d||!a.isBoolean(b)?!1:(b?(g.addClass(f),h.css("top","-3000px")):(g.removeClass(f),h.css("top",0)),b)},show:function(){var a=this,b=a.get("target");b.show()},hide:function(){var a=this,b=a.get("target");b.hide()}},{ATTRS:{target:{value:e},swfWrapper:{value:e},swfWrapperId:{value:e},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},multiple:{value:!0,setter:function(a){var b=this,c=b.get("swfUploader");return c&&c.multifile(a),a}},fileFilters:{value:[],setter:function(b){var c=this,d=c.get("swfUploader");return a.isObject(b)&&(b=[b]),d&&a.isArray(b)&&a.later(function(){d.filter(b)},500),b}},disabled:{value:!1,setter:function(a){var b=this,c=b.get("swfUploader");return c&&b._setDisabled(a),a}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/form/1.2/uploader/plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:!0,btn:!0}},swfUploader:{value:e}}}),h},{requires:["node","base","../plugins/ajbridge/uploader"]}),KISSY.add("gallery/form/1.2/uploader/index",function(a,b,c,d,e){function l(b,c,d){var e=this;d=a.mix(a.form.parseConfig(b),d),l.superclass.constructor.call(e,d),e.set("buttonTarget",b),e.set("queueTarget",c),e.set("uploaderConfig",d),e._init()}var f="",g=c.all,h="[uploaderRender]:",i={CONFIG:"data-config",BUTTON_CONFIG:"data-button-config",THEME_CONFIG:"data-theme-config",AUTH:"data-auth"},j=["default","imageUploader","ershouUploader","uploadify"],k="gallery/form/1.2/uploader/themes/";return a.namespace("form"),a.form.parseConfig=function(b,c){var d={},e,f=c||i.CONFIG;e=g(b).attr(f);if(!a.isString(e))return{};try{d=a.JSON.parse(e)}catch(j){a.log(h+"\u8bf7\u68c0\u67e5"+b+"\u4e0a"+f+"\u5c5e\u6027\u5185\u7684json\u683c\u5f0f\u662f\u5426\u7b26\u5408\u89c4\u8303\uff01")}return d},a.extend(l,b,{_init:function(){var b=this,c=b.get("theme"),d;c==f?(d=b._initUploader(),b.set("button",d.get("button")),a.later(function(){b.fire("init",{uploader:d,button:d.get("button"),queue:d.get("queue"),auth:d.get("auth")})},500)):b._initThemes(function(a){d=b._initUploader(),b.set("button",d.get("button")),a.set("uploader",d),a.set("button",d.get("button")),a.set("queue",d.get("queue")),a.set("auth",d.get("auth")),a._UploaderRender(function(){a.afterUploaderRender(d),d.restore(),b.fire("init",{uploader:d,button:d.get("button"),queue:d.get("queue"),auth:d.get("auth")})})})},_initUploader:function(){var b=this,c=b.get("uploaderConfig"),e=b.get("name");a.mix(c.serverConfig,{fileDataName:e}),a.mix(c,{target:b.get("buttonTarget")});var f=new d(c);return f.render(),b.set("uploader",f),b._auth(),f},_initThemes:function(b){var c=this,d=c.get("theme"),e=c.get("buttonTarget"),f=c.get("themeConfig"),g=a.form.parseConfig(e,i.THEME_CONFIG);a.mix(g,f),c.set("themeConfig",g),d=c._getThemeName(d),a.use(d,function(a,d){var e=c.get("queueTarget"),f;a.mix(g,{queueTarget:e,buttonTarget:c.get("buttonTarget")}),f=new d(g),f.on("render",function(){b&&b.call(c,f)}),f.render()})},_getThemeName:function(b){var c=b;return a.each(j,function(a){a==b&&(c=k+b)}),c+="/index",c},_auth:function(){var b=this,c=b.get("buttonTarget"),d=b.get("uploader"),f=b.get("authConfig"),g=a.form.parseConfig(c,i.AUTH);return a.mix(g,f),b.set("authConfig",g),a.isEmptyObject(g)?!1:(auth=new e(d,{rules:g}),d.set("auth",auth),auth)}},{ATTRS:{theme:{value:"default"},themeConfig:{value:{}},buttonTarget:{value:f},queueTarget:{value:f},uploaderConfig:{},authConfig:{value:{}},button:{value:f},queue:{value:f},uploader:{value:f}}}),l},{requires:["base","node","./base","./auth/base"]}),KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/ajbridge",function(a,b){function h(d,i,j){d=d.replace(c,""),i=b._normalize(i||{});var k=this,l=c+d,m=function(b){if(b.status<1){k.fire("failed",{data:b});return}a.mix(k,b),(!b.dynamic||!i.src)&&k.activate()};i.id=i.id||a.guid(e),h.instances[i.id]=k,i.src&&(i.params.allowscriptaccess="always",i.params.flashvars=a.merge(i.params.flashvars,{jsEntry:g,swfID:i.id})),j?k.__args=[l,i,m]:a.later(b.add,f,!1,b,[l,i,m])}var c="#",d="1.0.15",e="ks-ajb-",f=100,g="KISSY.AJBridge.eventHandler";return a.mix(h,{version:d,instances:{},eventHandler:function(a,b){var c=h.instances[a];c&&c.__eventHandler(a,b)},augment:function(b,c){a.isString(c)&&(c=[c]);if(!a.isArray(c))return;a.each(c,function(c){b.prototype[c]=function(){try{return this.callSWF(c,a.makeArray(arguments))}catch(b){this.fire("error",{message:b})}}})}}),a.augment(h,a.EventTarget,{init:function(){if(!this.__args)return;b.add.apply(b,this.__args),this.__args=null,delete this.__args},__eventHandler:function(b,c){var d=this,e=c.type;c.id=b;switch(e){case"log":a.log(c.message);break;default:d.fire(e,c)}},callSWF:function(a,b){var c=this;b=b||[];try{if(c.swf[a])return c.swf[a].apply(c.swf,b)}catch(d){var e="";return b.length!==0&&(e="'"+b.join("','")+"'"),(new Function("self","return self.swf."+a+"("+e+");"))(c)}}}),h.augment(h,["activate","getReady","getCoreVersion"]),window.AJBridge=a.AJBridge=h,h},{requires:["flash"]}),KISSY.add("gallery/form/1.2/uploader/plugins/ajbridge/uploader",function(a,b,c){function d(b,c){c=c||{};var e={};a.each(["ds","dsp","btn","hand"],function(a){a in c&&(e[a]=c[a])}),c.params=c.params||{},c.params.flashvars=a.merge(c.params.flashvars,e),d.superclass.constructor.call(this,b,c)}return a.extend(d,c),c.augment(d,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]),d.version="1.0.1",c.Uploader=d,c.Uploader},{requires:["flash","./ajbridge"]}),KISSY.add("gallery/form/1.2/uploader/plugins/filedrop/filedrop",function(a,b,c){var d="",e=b.all,f=a.UA,g=function(a){var b=this;g.superclass.constructor.call(b,a),b.set("mode",h())},h=function(){if(f.webkit>=7||f.firefox>=3.6)return"supportDrop";if(f.ie)return"notSupportDropIe";if(f.webkit<7||f.firefox<3.6)return"notSupportDrop"};return a.mix(g,{event:{AFTER_DROP:"afterdrop"}}),a.extend(g,c,{render:function(){var b=this,c=b.get("mode"),d=b.get("uploader"),e;if(d.get("type")=="flash")return a.log("flash\u4e0a\u4f20\u65b9\u5f0f\u4e0d\u652f\u6301\u62d6\u62fd\uff01"),b.set("isSupport",!1),!1;if(c!="supportDrop")return a.log("\u8be5\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u62d6\u62fd\u4e0a\u4f20\uff01"),b.set("isSupport",!1),!1;if(!d)return a.log("\u7f3a\u5c11Uploader\u7684\u5b9e\u4f8b\uff01"),!1;e=b._createDropArea(),e.length&&e.on("click",b._clickHandler,b),d.on("afterDisabledChange",function(a){b[a.newVal&&"hide"||"show"]()}),b.fire("afterRender",{buttonTarget:b.get("buttonWrap")})},show:function(){var a=this,b=a.get("dropContainer");b.show()},hide:function(){var a=this,b=a.get("dropContainer");b.hide()},reset:function(){},_createDropArea:function(){var b=this,c=e(b.get("target")),d=b.get("mode"),f=a.substitute(b.get("tpl")[d],{name:b.get("name")}),g=e(f),h=g.all(".J_ButtonWrap");return g.appendTo(c),g.on("dragover",function(a){a.stopPropagation(),a.preventDefault()}),g.on("drop",function(a){a.stopPropagation(),a.preventDefault(),b._dropHandler(a)}),b.set("dropContainer",g),b.set("buttonWrap",h),b._setStyle(),g},_setStyle:function(){var a=this,b=a.get("dropContainer");if(!b.length)return!1;b.parent().css("position","relative"),b.css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"1000"})},_clickHandler:function(a){var b=this,c=e(a.target),d=b.get("uploader"),f=d.get("button"),g=f.get("fileInput");g.fire("click")},_dropHandler:function(b){var c=this,e=g.event,f=b.originalEvent.dataTransfer.files,h=[],i=c.get("uploader");if(!f.length||i==d)return!1;a.each(f,function(b){a.isObject(b)&&h.push({name:b.name,type:b.type,size:b.size,data:b})}),c.fire(e.AFTER_DROP,{files:h}),i._select({files:h})},_setDisabled:function(){}},{ATTRS:{target:{value:d},uploader:{value:d},dropContainer:{value:d},isSupport:{value:!0},tpl:{value:{supportDrop:'<div class="drop-wrapper"><p>\u76f4\u63a5\u62d6\u62fd\u56fe\u7247\u5230\u8fd9\u91cc\uff0c</p><p class="J_ButtonWrap">\u6216\u8005</p></div>',notSupportDropIe:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u4f7f\u7528chrome\u6d4f\u89c8\u5668\u6216firefox\u6d4f\u89c8\u5668</p></div>',notSupportDrop:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u5347\u7ea7\u60a8\u7684\u6d4f\u89c8\u5668</p></div>'}},name:{value:"",setter:function(a){}},disabled:{value:!1,setter:function(a){return this._setDisabled(a),a}},cls:{disabled:"drop-area-disabled"}}}),g},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/plugins/preview/preview",function(a,b,c){function i(){var b="";if(typeof window.FileReader=="undefined")switch(a.UA.shell){case"firefox":b="domfile";break;case"ie":switch(a.UA.ie){case 6:b="simple";break;default:b="filter"}}else b="html5";return b}function j(a,b,c,d){return a?(f!="filter"?a.src=b||h:(a.src=h,b&&(b=b.replace(/[)'"%]/g,function(a){return escape(escape(a))}),a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='"+b+"')",a.zoom=1)),!0):!1}function k(b){var c=this,d={maxWidth:40,maxHeight:40};c.config=a.mix(d,b),a.log(e+"Preview initialized. The preview mode is "+f)}var d=document,e="[Plugin: Preview] ",f=i(),g={check:"check",success:"success",showed:"showed",error:"error"},h=a.UA.ie<8?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";return a.augment(k,a.EventTarget,{preview:function(c,h){c=b.get(c),h=b.get(h);var i=this,k=function(){i.fire(g.getData,{data:i.data,mode:f}),h&&(j(h,i.data),i.fire(g.showed,{img:h}))};i.data=undefined;if(c){a.log(e+"One file selected. Getting data...");switch(f){case"domfile":i.data=c.files[0].getAsDataURL();break;case"filter":c.select();try{i.data=d.selection.createRange().text}catch(l){a.log(e+"Get image data error, the error is: "),a.log(l,"dir")}finally{d.selection.empty()}i.data||(i.data=c.value);break;case"html5":var m=new FileReader;m.onload=function(a){i.data=a.target.result,k()},m.onerror=function(b){a.log(e+"File Reader Error. Your browser may not fully support html5 file api","warning"),i.fire(g.error)},c.files&&m.readAsDataURL(c.files[0]);break;case"simple":default:i.data=c.value}i.data?k():f!="html5"&&(a.log(e+"Retrive Data error."),j(h),i.fire(g.error))}else a.log(e+"File Input Element does not exists.");return i.data}}),k},{requires:["dom","event"]}),KISSY.add("gallery/form/1.2/uploader/plugins/progressBar/progressBar",function(a,b,c){function l(b,c){var d=this;c=a.merge({wrapper:e(b)},c),l.superclass.constructor.call(d,c)}var d="",e=b.all,f="progressbar",g="role",h="aria-valuemin",i="aria-valuemax",j="aria-valuenow",k="data-value";return a.mix(l,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}}),a.extend(l,c,{render:function(){var a=this,b=a.get("wrapper"),c=a.get("width");if(!b.length)return!1;b.addClass(l.cls.PROGRESS_BAR).width(c),a._addAttr(),!a.get("visible")&&a.hide(),a.set("bar",a._create()),a.fire(l.event.RENDER)},show:function(){var a=this,b=a.get("wrapper");b.fadeIn(a.get("duration"),function(){a.set("visible",!0),a.fire(l.event.SHOW,{visible:!0})})},hide:function(){var a=this,b=a.get("wrapper");b.fadeOut(a.get("duration"),function(){a.set("visible",!1),a.fire(l.event.HIDE,{visible:!1})})},_create:function(){var b=this,c=b.get("wrapper"),d=b.get("value"),f=b.get("tpl"),g=a.substitute(f,{value:d});return c.html(""),e(g).appendTo(c)},_addAttr:function(){var a=this,b=a.get("wrapper"),c=a.get("value");return b.attr(g,f),b.attr(h,0),b.attr(i,100),b.attr(j,c),a}},{ATTRS:{wrapper:{value:d},bar:{value:d},width:{value:100},value:{value:0,setter:function(a){var b=this,c=b.get("wrapper"),d=b.get("bar"),e=b.get("speed"),f;return a>100&&(a=100),a<0&&(a=0),f=c.width()*(a/100),d.animate({width:f+"px"},e,"none",function(){c.attr(j,a),d.attr(k,a),b.fire(l.event.CHANGE,{value:a,width:f})}),a}},visible:{value:!0},duration:{value:.3},tpl:{value:l.tpl.DEFAULT},speed:{value:.2}}}),l},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/queue",function(a,b,c){function g(a){var b=this;g.superclass.constructor.call(b,a)}var d="",e=b.all,f="[uploader-queue]:";return a.mix(g,{tpl:{DEFAULT:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="f-l sprite file-icon"></div><div class="f-l">{name}</div><div class="f-l file-status J_FileStatus"></div></li>'},event:{ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"statusChange",UPDATE_FILE:"updateFile",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},cls:{QUEUE:"ks-uploader-queue"},hook:{STATUS:".J_FileStatus"},FILE_ID_PREFIX:"file-"}),a.extend(g,c,{add:function(b,c){var d=this,e={};return b.length>0?(e=[],a.each(b,function(a){e.push(d._addFile(a))})):e=d._addFile(b),c&&c.call(d),e},_addFile:function(b,c){if(!a.isObject(b))return a.log(f+"_addFile()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1;var d=this,e=d._setAddFileData(b),h=d.getFileIndex(e.id),i=d.get("fnAdd");return a.isFunction(i)&&(e=i(h,e)),d.fire(g.event.ADD,{index:h,file:e,uploader:d.get("uploader")}),c&&c.call(d,h,e),e},remove:function(b,c){var d=this,e=d.get("files"),h;return a.isString(b)&&(b=d.getFileIndex(b)),h=e[b],a.isObject(h)?(e=a.filter(e,function(a,c){return c!==b}),d.set("files",e),d.fire(g.event.REMOVE,{index:b,file:h}),c&&c.call(d,b,h),h):(a.log(f+"remove()\u4e0d\u5b58\u5728index\u4e3a"+b+"\u7684\u6587\u4ef6\u6570\u636e"),!1)},clear:function(){function c(){b=a.get("files");if(!b.length)return a.fire(g.event.CLEAR),!1;a.remove(0,function(){c()})}var a=this,b;c()},fileStatus:function(b,c,d){if(!a.isNumber(b))return!1;var e=this,f=e.getFile(b),h=e.get("theme"),i,j;return f?(i=f.status,c?i==c?e:(e.updateFile(b,{status:c}),j="_"+c+"Handler",h&&a.isFunction(h[j])&&(d=a.merge({uploader:e.get("uploader"),index:b,file:f,id:f.id},d),h[j].call(h,d)),e.fire(g.event.FILE_STATUS,{index:b,status:c,args:d,file:f}),e):i):!1},getFile:function(b){if(!a.isNumber(b))return!1;var c=this,d=c.get("files"),e=d[b];return a.isPlainObject(e)||(a.log("getFile():\u6587\u4ef6\u6570\u636e\u4e3a\u7a7a\uff01"),e={}),e},getFileIndex:function(b){var c=this,d=c.get("files"),e=-1;return a.each(d,function(a,c){if(a.id==b)return e=c,!0}),e},updateFile:function(b,c){if(!a.isNumber(b))return!1;if(!a.isObject(c))return a.log(f+"updateFile()\u7684data\u53c2\u6570\u6709\u8bef\uff01"),!1;var d=this,e=d.get("files"),h=d.getFile(b);return h?(a.mix(h,c),e[b]=h,d.set("files",e),d.fire(g.event.UPDATE_FILE,{index:b,file:h}),h):!1},getIndexs:function(b){var c=this,d=c.get("files"),e,f=[];return d.length?(a.each(d,function(c,d){a.isObject(c)&&(e=c.status,e==b&&f.push(d))}),f):f},getFiles:function(b){var c=this,d=c.get("files"),e=[];return d.length?(a.each(d,function(a){a&&a.status==b&&e.push(a)}),e):[]},_setAddFileData:function(b){var c=this,e=c.get("files");return a.isObject(b)?(b.id||(b.id=a.guid(g.FILE_ID_PREFIX)),b.size&&(b.textSize=a.convertByteSize(b.size)),b.status=d,e.push(b),b):(a.log(f+"_updateFileData()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1)}},{ATTRS:{fnAdd:{value:d},files:{value:[]},uploader:{value:d},theme:{value:d}}}),g},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/theme",function(a,b,c){function g(a){var b=this;g.superclass.constructor.call(b,a)}var d="",e=b.all,f={BUTTON:"-button",QUEUE:"-queue"};return a.extend(g,c,{render:function(){var a=this;a._LoaderCss(function(){a._addThemeCssName(),a.fire("render")})},afterUploaderRender:function(a){},_getStatusWrapper:function(a){return a&&a.children(".J_FileStatus")||e("")},displayFile:function(a,b,c){var d=this,e=d.get("duration");if(!b||!b.length)return!1;b[a&&"fadeIn"||"fadeOut"](e,function(){c&&c.call(d)})},_waitingHandler:function(a){},_startHandler:function(a){},_progressHandler:function(a){},_successHandler:function(a){},_errorHandler:function(a){},_restoreHandler:function(a){},_UploaderRender:function(a){var b=this;b._initQueue(),b._loadPlugins(a)},_addThemeCssName:function(){var a=this,b=a.get("name"),c=e(a.get("queueTarget")),g=e(a.get("buttonTarget"));if(b==d)return!1;c.length&&c.addClass(b+f.QUEUE),g.addClass(b+f.BUTTON)},_initQueue:function(){var a=this,b=a.get("queue");return b.set("fnAdd",function(b,c){return a._addCallback(b,c)}),b.set("theme",a),b.on("add",a._addFileHandler,a),b.on("remove",a._removeFileHandler,a),b.on("statusChange",function(b){a._setStatusVisibility(b)}),b},_LoaderCss:function(b){var c=this,e=c.get("cssUrl");if(e==d)return b.call(c),!1;a.use(e,function(){a.log(e+"\u52a0\u8f7d\u6210\u529f\uff01"),b.call(c)})},_addCallback:function(a,b){var c=this,d=c.get("queue"),e=c._appendFileDom(b);return d.updateFile(a,{target:e,statusWrapper:c._getStatusWrapper(e)}),d.fileStatus(a,"waiting"),c.displayFile(!0,e),c._bindTriggerEvent(a,b),d.getFile(a)},_removeFileHandler:function(a){var b=this,c=a.file;b.displayFile(!1,c.target)},_bindTriggerEvent:function(b,c){var d=this,f=d.get("queue"),g=d.get("uploader"),h=c.id,i=e(".J_Upload_"+h),j=e(".J_Cancel_"+h),k=e(".J_Del_"+h);i.on("click",function(c){c.preventDefault();if(!a.isObject(g))return!1;g.upload(b)}),j.on("click",function(a){a.preventDefault(),g.cancel(b)}),k.on("click",function(a){a.preventDefault(),f.remove(h)})},_setStatusVisibility:function(b){var c=b.file.statusWrapper,d,e=b.file,f=e.status
;if(!c||!c.length)return a.log("\u72b6\u6001\u5bb9\u5668\u5c42\u4e0d\u5b58\u5728\uff01"),!1;d=c.children(".status"),d.hide(),c.children("."+f+"-status").show()},_appendFileDom:function(b){var c=this,d=c.get("fileTpl"),f=e(c.get("queueTarget")),g;return f.length?(g=a.substitute(d,b),e(g).hide().appendTo(f).data("data-file",b)):!1},_loadPlugins:function(b){var c=this,d=c.get("plugins"),e=c.get("oPlugin"),f="gallery/form/1.2/uploader/plugins/",g=[];if(!d.length)return b&&b.call(c,e),!1;a.each(d,function(a){g.push(f+a+"/"+a)}),a.use(g.join(","),function(){a.each(arguments,function(a,b){b>=1&&(e[d[b-1]]=a)}),c.set("oPlugin",e),b&&b.call(c,e)})}},{ATTRS:{name:{value:d},cssUrl:{value:d},fileTpl:{value:d},plugins:{value:[]},oPlugin:{value:{}},queueTarget:{value:d},duration:{value:.3},queue:{value:d},uploader:{value:d},button:{value:d},auth:{value:d}}}),g},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/type/ajax",function(a,b,c){function g(a){var b=this;g.superclass.constructor.call(b,a)}var d="",e=b.all,f="[uploader-AjaxType]:";return a.mix(g,{event:a.merge(c.event,{PROGRESS:"progress"})}),a.extend(g,c,{upload:function(b){if(!b)return a.log(f+"upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),!1;var c=this;return c._setFormData(),c._addFileData(b),c.send(),c},stop:function(){var b=this,c=b.get("xhr");return a.isObject(c)?(c.abort(),b.fire(g.event.STOP),b):(a.log(f+"stop()\uff0cio\u503c\u9519\u8bef\uff01"),!1)},send:function(){var b=this,c=b.get("action"),d=b.get("formData"),e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(a){b.fire(g.event.PROGRESS,{loaded:a.loaded,total:a.total})}),e.onload=function(c){var d={};try{d=a.JSON.parse(e.responseText)}catch(h){a.log(f+"ajax\u8fd4\u56de\u7ed3\u679c\u96c6responseText\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01")}b.fire(g.event.SUCCESS,{result:d})},e.open("POST",c,!0),d.append("type","ajax"),e.send(d),b._setFormData(),b.set("xhr",e),b},_setFormData:function(){var b=this;try{b.set("formData",new FormData),b._processData()}catch(c){a.log(f+"something error when reset FormData."),a.log(c,"dir")}},_processData:function(){var b=this,c=b.get("data"),d=b.get("formData");a.each(c,function(a,b){d.append(b,a)}),b.set("formData",d)},_addFileData:function(b){if(!a.isObject(b))return a.log(f+"_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var c=this,d=c.get("formData"),e=c.get("fileDataName");d.append(e,b),c.set("formData",d)}},{ATTRS:{formData:{value:d},ajaxConfig:{value:{type:"post",processData:!1,cache:!1,dataType:"json",contentType:!1}},xhr:{value:d},fileDataName:{value:d},form:{value:{}},fileInput:{value:d}}}),g},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/type/base",function(a,b,c){function f(a){var b=this;f.superclass.constructor.call(b,a)}var d="",e=b.all;return a.mix(f,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}}),a.extend(f,c,{upload:function(){},stop:function(){}},{ATTRS:{action:{value:d},data:{value:{}}}}),f},{requires:["node","base"]}),KISSY.add("gallery/form/1.2/uploader/type/flash",function(a,b,c,d){function h(a){var b=this;h.superclass.constructor.call(b,a),b.isHasCrossdomain(),b._init()}var e="",f=b.all,g="[uploader-FlashType]:";return a.mix(h,{event:a.merge(c.event,{SWF_READY:"swfReady",PROGRESS:"progress"})}),a.extend(h,c,{_init:function(){var b=this,c=b.get("swfUploader");if(!c)return a.log(g+"swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1;c.on("contentReady",function(a){b.fire(h.event.SWF_READY)},b),c.on("uploadStart",b._uploadStartHandler,b),c.on("uploadProgress",b._uploadProgressHandler,b),c.on("uploadCompleteData",b._uploadCompleteDataHandler,b),c.on("uploadError",b._uploadErrorHandler,b)},upload:function(b){var c=this,d=c.get("swfUploader"),e=c.get("action"),f="POST",g=c.get("data"),h=c.get("fileDataName");return h||(h="Filedata"),c.set("uploadingId",b),a.mix(g,{type:"flash"}),d.upload(b,e,f,g,h),c},stop:function(){var a=this,b=a.get("swfUploader"),c=a.get("uploadingId");return c!=e&&(b.cancel(c),a.fire(h.event.STOP,{id:c})),a},_uploadStartHandler:function(a){var b=this;b.fire(h.event.START,{file:a.file})},_uploadProgressHandler:function(b){var c=this;a.mix(b,{loaded:b.bytesLoaded,total:b.bytesTotal}),a.log(g+"\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+b.bytesLoaded),c.fire(h.event.PROGRESS,{loaded:b.loaded,total:b.total})},_uploadCompleteDataHandler:function(b){var c=this,d;try{d=JSON.parse(b.data)}catch(f){a.log(g+"json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),c.fire(h.event.ERROR,{msg:"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}a.log(g+"\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+d),c.set("uploadingId",e),c.fire(h.event.SUCCESS,{result:d})},_uploadErrorHandler:function(a){var b=this;b.set("uploadingId",e),b.fire(h.event.ERROR,{msg:a.msg})},isHasCrossdomain:function(){var b=location.hostname;a.io({url:"http://"+b+"/crossdomain.xml",dataType:"xml",error:function(){a.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{action:{value:e,getter:function(b){var c=/^http/;if(!c.test(b)){var d=location.href,e=d.split("/"),f;f=a.filter(e,function(a,b){return b<e.length-1}),b=f.join("/")+"/"+b}return b}},swfUploader:{value:e},uploadingId:{value:e}}}),h},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/type/iframe",function(a,b,c){function h(a){var b=this;h.superclass.constructor.call(b,a)}var d="",e=b.all,f="[uploader-iframeType]:",g="ks-uploader-iframe-";return a.mix(h,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}" style="visibility: hidden;">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:a.mix(c.event,{CREATE:"create",REMOVE:"remove"})}),a.extend(h,c,{upload:function(b){var c=this,d=e(b),g;if(!d.length)return!1;c.fire(h.event.START,{input:d}),c.set("fileInput",d),c._create(),g=c.get("form");if(!g)return a.log(f+"form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1;g.getDOMNode().submit()},stop:function(){var a=this,b=a.get("iframe");return b.attr("src",'javascript:"<html></html>";'),a._remove(),a.fire(h.event.STOP),a.fire(h.event.ERROR,{status:"abort",msg:"\u4e0a\u4f20\u5931\u8d25\uff0c\u539f\u56e0\uff1aabort"}),a},dataToHidden:function(b){if(!a.isObject(b)||a.isEmptyObject(b))return"";var c=this,e=d,f=c.get("tpl"),g=f.HIDDEN_INPUT;if(!a.isString(g))return"";for(var h in b)e+=a.substitute(g,{name:h,value:b[h]});return e},_createIframe:function(){var b=this,c=g+a.guid(),d=b.get("tpl"),h=d.IFRAME,i=b.get("iframe"),j,k;return a.isEmptyObject(i)?a.isString(h)?a.isString(c)?(j=a.substitute(d.IFRAME,{id:c}),k=e(j),k.on("load",b._iframeLoadHandler,b),e("body").append(k),b.set("id",c),b.set("iframe",k),k):(a.log(f+"id\u5fc5\u987b\u5b58\u5728\u4e14\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff01"),!1):(a.log(f+"iframe\u7684\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1):i},_iframeLoadHandler:function(b){var c=this,e=b.target,g=h.event.ERROR,i=e.contentDocument||window.frames[e.id].document,j;if(!i||!i.body)return c.fire(g,{msg:"\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u6570\u636e\u6709\u95ee\u9898\uff01"}),!1;j=i.body.innerHTML,a.log(f+"\u670d\u52a1\u5668\u7aef\u8f93\u51fa:"+j);if(j==d)return!1;try{j=JSON.parse(j)}catch(k){a.log(f+"json\u6570\u636e\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01"),c.fire(g,{msg:"\u6570\u636e\uff1a"+j+"\u4e0d\u662f\u5408\u6cd5\u7684json\u6570\u636e"})}c.fire(h.event.SUCCESS,{result:j}),c._remove()},_createForm:function(){var b=this,c=b.get("id"),d=b.get("tpl"),g=d.FORM,h=b.get("data"),i=b.get("action"),j=b.get("fileInput"),k,l,m;return a.isString(g)?a.isString(i)?(k=b.dataToHidden(h),k+=b.dataToHidden({type:"iframe"}),m=a.substitute(g,{action:i,target:c,hiddenInputs:k}),l=e(m).append(j),e("body").append(l),b.set("form",l),l):(a.log(f+"action\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1):(a.log(f+"form\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1)},_create:function(){var a=this,b=a._createIframe(),c=a._createForm();a.fire(h.event.CREATE,{iframe:b,form:c})},_remove:function(){var b=this,c=b.get("form");if(!c)return a.log(f+"form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1;c.remove(),b.reset("form"),b.fire(h.event.REMOVE,{form:c})}},{ATTRS:{tpl:{value:h.tpl},id:{value:g+a.guid()},iframe:{value:{}},form:{value:{}},fileInput:{value:d}}}),h},{requires:["node","./base"]}),KISSY.add("gallery/form/1.2/uploader/urlsInput",function(a,b,c){function g(a,b){var c=this;g.superclass.constructor.call(c,b),c.set("wrapper",e(a))}var d="",e=b.all,f="[uploader-urlsInput]:";return a.mix(g,{TPL:'<input type="hidden" id="{name}" name="{name}" value="{value}" />'}),a.extend(g,c,{render:function(){var b=this,c=b.get("wrapper"),d=b.get("name"),g=document.getElementsByName(d)[0];return a.isObject(c)?(g?(a.log(f+"urls input found"),b.set("input",e(g))):b._create(),b):(a.log(f+"container\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1)},add:function(b){if(!a.isString(b))return a.log(f+"add()\u7684url\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1;var c=this,e=c.get("urls"),g=c.isExist(b);return e[0]==d&&(e=[]),g?(a.log(f+"add()\uff0c\u6587\u4ef6\u8def\u5f84\u5df2\u7ecf\u5b58\u5728\uff01"),c):(e.push(b),c.set("urls",e),c._val(),c)},remove:function(b){if(!b)return!1;var c=this,d=c.get("urls"),e=c.isExist(b),g=new RegExp(b);return e?(d=a.filter(d,function(a){return!g.test(a)}),c.set("urls",d),c._val(),d):(a.log(f+"remove()\uff0c\u4e0d\u5b58\u5728\u8be5\u6587\u4ef6\u8def\u5f84\uff01"),!1)},parse:function(){var b=this,c=b.get("input");if(c){var d=e(c).val(),g=b.get("split"),h;return h=d.split(g),b.set("urls",h),h}return a.log(f+"cannot find urls input."),[]},_val:function(){var a=this,b=a.get("urls"),c=a.get("input"),d=a.get("split"),e=b.join(d);return c.val(e),e},isExist:function(b){var c=this,d=!1,e=c.get("urls"),f=new RegExp(b);return e.length?(a.each(e,function(a){if(f.test(a))return d=!0}),d):!1},_create:function(){var b=this,c=b.get("wrapper"),d=b.get("tpl"),g=b.get("name"),h=b.get("urls"),i;return!c||c.length<=0?(a.log(f+"UrlsInput container not specified!","warn"),!1):!a.isString(d)||!a.isString("name")?(a.log(f+"_create()\uff0ctpl\u548cname\u5c5e\u6027\u4e0d\u5408\u6cd5\uff01"),!1):(i=e(a.substitute(d,{name:g,value:h})),c.append(i),b.set("input",i),a.log(f+"input created."),i)}},{ATTRS:{name:{value:d},urls:{value:[]},tpl:{value:g.TPL},split:{value:",",setter:function(a){var b=this;return b._val(),a}},input:{value:d},wrapper:{value:d}}}),g},{requires:["node","base"]});